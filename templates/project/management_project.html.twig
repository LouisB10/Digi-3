{% extends 'base.html.twig' %}

{% block title %}Digi 3 - Gestion Projets{% endblock %}

{% block head_meta %}
    {{ parent() }}
    <meta name="csrf-token" content="{{ csrf_token('app') }}">
    <meta name="csrf-token-project" content="{{ csrf_token('project_form') }}">
    <meta name="csrf-token-task" content="{{ csrf_token('task_form') }}">
    <meta name="csrf-token-delete" content="{{ csrf_token('delete-project') }}">
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('project') }}
    {{ encore_entry_script_tags('project_management') }}
{% endblock %}

{% block body %}

{% include 'includes/header.html.twig' %}

<div class="project-management-container">
    <aside class="parameter_menu" role="complementary" aria-label="Liste des projets">
        <h3 id="project-list-heading">Liste des projets</h3>
        <ul aria-labelledby="project-list-heading">
            {% for project in projects %}
            <li class="{{ current_project and current_project.id == project.id ? 'active' : '' }}">
                <a href="{{ path('app_management_project', { 'id': project.id }) }}" {% if current_project and current_project.id == project.id %}aria-current="page"{% endif %}>
                    {{ project.projectName }}
                </a>
                <button type="button" class="delete-button" data-project-id="{{ project.id }}" aria-label="Supprimer le projet {{ project.projectName }}">
                    <img src="/build/images/delete.png" alt="" class="delete-icon" aria-hidden="true">
                </button>
            </li>
            {% endfor %}
        </ul>
    </aside>
      
<main class="project-details" role="main">
    {% if current_project %}
        <h2 id="project-title">{{ current_project.projectName }}</h2>
        <p>{{ current_project.projectDescription }}</p>

        <div class="project-dates" aria-labelledby="project-title">
            <div>
                <span id="start-date-label">Début prévisionnel :</span> <span aria-labelledby="start-date-label">{{ current_project.projectStartDate ? current_project.projectStartDate.format('d-m-Y') : 'Non défini' }}</span>
            </div>
            <div>
                <span id="target-date-label">Fin prévisionnelle :</span> <span aria-labelledby="target-date-label">{{ current_project.projectTargetDate ? current_project.projectTargetDate.format('d-m-Y') : 'Non défini' }}</span>
                <span id="end-date-label">Fin réelle :</span> <span class="real" aria-labelledby="end-date-label">{{ current_project.projectEndDate ? current_project.projectEndDate.format('d-m-Y') : 'Non défini' }}</span>
            </div>
        </div>

        <div>
            <label id="project-manager-label">Chef de projet :</label>
            <span aria-labelledby="project-manager-label">
                {{ current_project.projectManager ? current_project.projectManager.getFullName() : 'Non défini' }}
            </span>
            <br>           
            {% if permissions.canCreateTask %}
            <button class="add-task-button" id="createTaskBtn" aria-label="Créer une nouvelle tâche">Créer une tâche</button>
            {% endif %}
            {% if current_project %}
            <div id="createTaskForm" style="display: none;" aria-labelledby="task-form-title">
                <h3 id="task-form-title" class="visually-hidden">Formulaire de création de tâche</h3>
                {{ form_start(taskForm, {'attr': {'id': 'taskForm', 'aria-labelledby': 'task-form-title'}}) }}
                    <input type="hidden" name="_token" value="{{ csrf_token('task_form') }}">
                    {{ form_row(taskForm.taskName) }}
                    {{ form_row(taskForm.taskDescription) }}
                    {{ form_row(taskForm.taskType) }}
                    {{ form_row(taskForm.taskStatus) }}
                    {{ form_row(taskForm.taskPriority) }}
                    {{ form_row(taskForm.taskComplexity) }}
                    {{ form_row(taskForm.taskStartDate) }}
                    {{ form_row(taskForm.taskTargetDate) }}
                    <button type="submit">Ajouter la tâche</button>
                {{ form_end(taskForm, {'render_rest': false}) }}
            </div>
            {% endif %}
        </div>

        <br>

        <div class="kanban-board" role="region" aria-label="Tableau Kanban">
            <div class="kanban-column" data-column="a-faire" role="list" aria-label="Tâches à faire">
                <h3 id="todo-column-heading">À faire</h3>
                <div class="kanban-tasks" aria-labelledby="todo-column-heading">
                    {% for task in current_project.tasks %}
                        {% if task.taskStatus.value == 'new' %}
                        <div class="task-card" id="task-{{ task.id }}" draggable="true" data-task-id="{{ task.id }}" 
                            data-name="{{ task.taskName }}"
                            data-description="{{ task.taskDescription }}"
                            data-type="{{ task.taskType }}"
                            data-status="{{ task.taskStatus }}"
                            data-complexity="{{ task.taskComplexity }}"
                            data-date-from="{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}"
                            data-date-to="{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}"
                            role="listitem" aria-label="Tâche: {{ task.taskName }}">
                            <h4>{{ task.taskName }}</h4>
                            <div class="task-info">
                                <p><strong>Description :</strong> {{ task.taskDescription }}</p>
                                <p><strong>Type :</strong> {{ task.taskType }}</p>
                                <p><strong>Statut :</strong> {{ task.taskStatus }}</p>
                                <p><strong>Priorité :</strong> {{ task.taskPriority }}</p>
                                <p><strong>Complexité :</strong> {{ task.taskComplexity }}</p>
                                <p><strong>Date de début :</strong> <span>{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}</span></p>
                                <p><strong>Date de fin :</strong> <span>{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}</span></p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="kanban-column" data-column="bloque" role="list" aria-label="Tâches bloquées">
                <h3 id="blocked-column-heading">Bloquée</h3>
                <div class="kanban-tasks" aria-labelledby="blocked-column-heading">
                    {% for task in current_project.tasks %}
                        {% if task.taskStatus.value == 'blocked' %}
                        <div class="task-card" id="task-{{ task.id }}" draggable="true" data-task-id="{{ task.id }}" 
                            data-name="{{ task.taskName }}"
                            data-description="{{ task.taskDescription }}"
                            data-type="{{ task.taskType }}"
                            data-status="{{ task.taskStatus }}"
                            data-complexity="{{ task.taskComplexity }}"
                            data-date-from="{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}"
                            data-date-to="{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}"
                            role="listitem" aria-label="Tâche: {{ task.taskName }}">
                            <h4>{{ task.taskName }}</h4>
                            <div class="task-info">
                                <p><strong>Description :</strong> {{ task.taskDescription }}</p>
                                <p><strong>Type :</strong> {{ task.taskType }}</p>
                                <p><strong>Statut :</strong> {{ task.taskStatus }}</p>
                                <p><strong>Priorité :</strong> {{ task.taskPriority }}</p>
                                <p><strong>Complexité :</strong> {{ task.taskComplexity }}</p>
                                <p><strong>Date de début :</strong> <span>{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}</span></p>
                                <p><strong>Date de fin :</strong> <span>{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}</span></p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="kanban-column" data-column="en-cours" role="list" aria-label="Tâches en cours">
                <h3 id="in-progress-column-heading">En cours</h3>
                <div class="kanban-tasks" aria-labelledby="in-progress-column-heading">
                    {% for task in current_project.tasks %}
                        {% if task.taskStatus.value == 'in_progress' %}
                        <div class="task-card" id="task-{{ task.id }}" draggable="true" data-task-id="{{ task.id }}" 
                            data-name="{{ task.taskName }}"
                            data-description="{{ task.taskDescription }}"
                            data-type="{{ task.taskType }}"
                            data-status="{{ task.taskStatus }}"
                            data-complexity="{{ task.taskComplexity }}"
                            data-date-from="{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}"
                            data-date-to="{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}"
                            role="listitem" aria-label="Tâche: {{ task.taskName }}">
                            <h4>{{ task.taskName }}</h4>
                            <div class="task-info">
                                <p><strong>Description :</strong> {{ task.taskDescription }}</p>
                                <p><strong>Type :</strong> {{ task.taskType }}</p>
                                <p><strong>Statut :</strong> {{ task.taskStatus }}</p>
                                <p><strong>Priorité :</strong> {{ task.taskPriority }}</p>
                                <p><strong>Complexité :</strong> {{ task.taskComplexity }}</p>
                                <p><strong>Date de début :</strong> <span>{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}</span></p>
                                <p><strong>Date de fin :</strong> <span>{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}</span></p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="kanban-column" data-column="terminee" role="list" aria-label="Tâches terminées">
                <h3 id="completed-column-heading">Terminée</h3>
                <div class="kanban-tasks" aria-labelledby="completed-column-heading">
                    {% for task in current_project.tasks %}
                        {% if task.taskStatus.value == 'completed' %}
                        <div class="task-card" id="task-{{ task.id }}" draggable="true" data-task-id="{{ task.id }}" 
                            data-name="{{ task.taskName }}"
                            data-description="{{ task.taskDescription }}"
                            data-type="{{ task.taskType }}"
                            data-status="{{ task.taskStatus }}"
                            data-complexity="{{ task.taskComplexity }}"
                            data-date-from="{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}"
                            data-date-to="{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}"
                            role="listitem" aria-label="Tâche: {{ task.taskName }}">
                            <h4>{{ task.taskName }}</h4>
                            <div class="task-info">
                                <p><strong>Description :</strong> {{ task.taskDescription }}</p>
                                <p><strong>Type :</strong> {{ task.taskType }}</p>
                                <p><strong>Statut :</strong> {{ task.taskStatus }}</p>
                                <p><strong>Priorité :</strong> {{ task.taskPriority }}</p>
                                <p><strong>Complexité :</strong> {{ task.taskComplexity }}</p>
                                <p><strong>Date de début :</strong> <span>{{ task.taskStartDate ? task.taskStartDate.format('d-m-Y') : 'Non définie' }}</span></p>
                                <p><strong>Date de fin :</strong> <span>{{ task.taskEndDate ? task.taskEndDate.format('d-m-Y') : 'Non définie' }}</span></p>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        {% else %}
            <p>Sélectionnez un projet pour voir les détails.</p>
        {% endif %}

        {# Formulaire de création de projet #}
        <div id="createProjectForm" style="display: none;" aria-labelledby="project-form-title">
            <h3 id="project-form-title" class="visually-hidden">Formulaire de création de projet</h3>
            {{ form_start(form, {'attr': {'id': 'projectForm', 'aria-labelledby': 'project-form-title'}}) }}
                <input type="hidden" name="_token" value="{{ csrf_token('project_form') }}">
                {{ form_row(form.projectName) }}
                {{ form_row(form.projectDescription) }}
                {{ form_row(form.projectStartDate) }}
                {{ form_row(form.projectTargetDate) }}
                <button type="submit">Créer un nouveau projet</button>
            {{ form_end(form, {'render_rest': false}) }}
        </div>

        {# Messages flash #}
        {% for message in app.flashes('success') %}
            <div class="alert alert-success" role="alert">
                {{ message }}
            </div>
        {% endfor %}
</main>

{# Bouton flottant pour créer un projet #}
<button class="floating-add-project" id="createProjectBtn" aria-label="Créer un nouveau projet">
    <i class="fas fa-plus" aria-hidden="true"></i>
</button>

</div>

{# Popup de confirmation de suppression #}
<div id="deletePopup" class="popup" style="display: none;" role="dialog" aria-labelledby="delete-popup-title" aria-modal="true">
    <div class="popup-content">
        <h3 id="delete-popup-title" class="visually-hidden">Confirmation de suppression</h3>
        <p>Êtes-vous sûr de vouloir supprimer ce projet ?</p>
        <input type="hidden" id="delete-project-token" value="{{ csrf_token('delete-project') }}">
        <button id="confirmDelete" class="confirm-button">Confirmer</button>
        <button id="cancelDelete" class="cancel-button">Annuler</button>
    </div>
</div>

{# Modal de détail de tâche #}
<div id="taskDetailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close task-modal-close">&times;</span>
        <h2 id="taskTitle"></h2>
        <div class="task-details">
            <p><strong>Description:</strong> <span id="taskDescription"></span></p>
            <p><strong>Type:</strong> <span id="taskType"></span></p>
            <p><strong>Statut:</strong> <span id="taskStatus"></span></p>
            <p><strong>Catégorie:</strong> <span id="taskCategory"></span></p>
            <p><strong>Date de début:</strong> <span id="taskDateFrom"></span></p>
            <p><strong>Date de fin:</strong> <span id="taskDateTo"></span></p>
        </div>
        <div class="modal-footer">
            <a href="#" id="taskProjectLink" class="btn">Retour au projet</a>
        </div>
    </div>
</div>

{% endblock %}
