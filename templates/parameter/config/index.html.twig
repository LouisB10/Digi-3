{% extends 'base.html.twig' %}

{% block title %}Digi-3 - Configuration{% endblock %}

{% block head_meta %}
    <meta name="csrf-token" content="{{ csrf_token('app') }}">
    <meta name="csrf-token-backup-create" content="{{ csrf_token('backup-create') }}">
    <meta name="csrf-token-backup-restore" content="{{ csrf_token('backup-restore') }}">
    <meta name="csrf-token-backup-delete" content="{{ csrf_token('backup-delete') }}">
{% endblock %}

{% block body %}
{% include 'includes/header.html.twig' %}
{% set permissions = getUserPermissions() %}

<main id="main-content" role="main">
    <section class="parameter_landing flex">
        {% include 'parameter/_menu.html.twig' %}
        
        <div class="parameter_content">
            <div class="config-page">
                <h1>Configuration du système</h1>
                
                {% for label, messages in app.flashes %}
                    {% for message in messages %}
                        <div class="alert alert-{{ label }}" role="alert" aria-live="polite">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endfor %}
                
                <div class="config-tabs">
                    <div class="tabs-header" role="tablist">
                        <button class="tab-btn active" id="tab-general" data-tab="general" role="tab" aria-selected="true" aria-controls="general-tab">Général</button>
                        <button class="tab-btn" id="tab-email" data-tab="email" role="tab" aria-selected="false" aria-controls="email-tab">Email</button>
                        <button class="tab-btn" id="tab-security" data-tab="security" role="tab" aria-selected="false" aria-controls="security-tab">Sécurité</button>
                        <button class="tab-btn" id="tab-backup" data-tab="backup" role="tab" aria-selected="false" aria-controls="backup-tab">Sauvegarde</button>
                    </div>
                    
                    <div class="tabs-content">
                        <!-- Onglet Général -->
                        <div class="tab-content active" id="general-tab" role="tabpanel" aria-labelledby="tab-general">
                            <form id="generalForm" class="config-form">
                                <div class="form-group">
                                    <label for="siteName">Nom du site</label>
                                    <input type="text" id="siteName" name="siteName" value="{{ config.siteName|default('Digi-3') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="siteDescription">Description du site</label>
                                    <textarea id="siteDescription" name="siteDescription" rows="3">{{ config.siteDescription|default('') }}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="maintenanceMode">Mode maintenance</label>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="maintenanceMode" name="maintenanceMode" {% if config.maintenanceMode|default(false) %}checked{% endif %}>
                                        <label for="maintenanceMode"></label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="defaultLanguage">Langue par défaut</label>
                                    <select id="defaultLanguage" name="defaultLanguage">
                                        <option value="fr" {% if config.defaultLanguage|default('fr') == 'fr' %}selected{% endif %}>Français</option>
                                        <option value="en" {% if config.defaultLanguage|default('fr') == 'en' %}selected{% endif %}>English</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="dateFormat">Format de date</label>
                                    <select id="dateFormat" name="dateFormat">
                                        <option value="d/m/Y" {% if config.dateFormat|default('d/m/Y') == 'd/m/Y' %}selected{% endif %}>DD/MM/YYYY</option>
                                        <option value="Y-m-d" {% if config.dateFormat|default('d/m/Y') == 'Y-m-d' %}selected{% endif %}>YYYY-MM-DD</option>
                                        <option value="m/d/Y" {% if config.dateFormat|default('d/m/Y') == 'm/d/Y' %}selected{% endif %}>MM/DD/YYYY</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="timeFormat">Format d'heure</label>
                                    <select id="timeFormat" name="timeFormat">
                                        <option value="H:i" {% if config.timeFormat|default('H:i') == 'H:i' %}selected{% endif %}>24h (14:30)</option>
                                        <option value="h:i A" {% if config.timeFormat|default('H:i') == 'h:i A' %}selected{% endif %}>12h (02:30 PM)</option>
                                    </select>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn-submit">Enregistrer</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Onglet Email -->
                        <div class="tab-content" id="email-tab" role="tabpanel" aria-labelledby="tab-email">
                            <form id="emailForm" class="config-form">
                                <div class="form-group">
                                    <label for="mailDriver">Service d'envoi d'emails</label>
                                    <select id="mailDriver" name="mailDriver">
                                        <option value="smtp" {% if config.mailDriver|default('smtp') == 'smtp' %}selected{% endif %}>SMTP</option>
                                        <option value="sendmail" {% if config.mailDriver|default('smtp') == 'sendmail' %}selected{% endif %}>Sendmail</option>
                                        <option value="mailgun" {% if config.mailDriver|default('smtp') == 'mailgun' %}selected{% endif %}>Mailgun</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailHost">Hôte SMTP</label>
                                    <input type="text" id="mailHost" name="mailHost" value="{{ config.mailHost|default('') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailPort">Port SMTP</label>
                                    <input type="number" id="mailPort" name="mailPort" value="{{ config.mailPort|default('587') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailEncryption">Chiffrement</label>
                                    <select id="mailEncryption" name="mailEncryption">
                                        <option value="tls" {% if config.mailEncryption|default('tls') == 'tls' %}selected{% endif %}>TLS</option>
                                        <option value="ssl" {% if config.mailEncryption|default('tls') == 'ssl' %}selected{% endif %}>SSL</option>
                                        <option value="none" {% if config.mailEncryption|default('tls') == 'none' %}selected{% endif %}>Aucun</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailUsername">Nom d'utilisateur</label>
                                    <input type="text" id="mailUsername" name="mailUsername" value="{{ config.mailUsername|default('') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailPassword">Mot de passe</label>
                                    <div class="password-container">
                                        <input type="password" id="mailPassword" name="mailPassword" value="{{ config.mailPassword|default('') }}">
                                        <span class="toggle-password" data-target="mailPassword" aria-label="Afficher/Masquer le mot de passe" role="button" tabindex="0">
                                            <img src="{{ asset('build/images/icons/eye.png') }}" alt="" aria-hidden="true">
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailFromAddress">Adresse d'expédition</label>
                                    <input type="email" id="mailFromAddress" name="mailFromAddress" value="{{ config.mailFromAddress|default('') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="mailFromName">Nom d'expédition</label>
                                    <input type="text" id="mailFromName" name="mailFromName" value="{{ config.mailFromName|default('Digi-3') }}">
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" id="test-email-config-btn">Tester la configuration</button>
                                    <button type="submit" class="btn-submit">Enregistrer</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Onglet Sécurité -->
                        <div class="tab-content" id="security-tab" role="tabpanel" aria-labelledby="tab-security">
                            <form id="securityForm" class="config-form">
                                <div class="form-group">
                                    <label for="sessionLifetime">Durée de session (minutes)</label>
                                    <input type="number" id="sessionLifetime" name="sessionLifetime" value="{{ config.sessionLifetime|default('120') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="passwordPolicy">Politique de mot de passe</label>
                                    <select id="passwordPolicy" name="passwordPolicy">
                                        <option value="low" {% if config.passwordPolicy|default('medium') == 'low' %}selected{% endif %}>Basique (min. 6 caractères)</option>
                                        <option value="medium" {% if config.passwordPolicy|default('medium') == 'medium' %}selected{% endif %}>Moyenne (min. 8 caractères, 1 majuscule, 1 chiffre)</option>
                                        <option value="high" {% if config.passwordPolicy|default('medium') == 'high' %}selected{% endif %}>Élevée (min. 10 caractères, majuscules, chiffres, caractères spéciaux)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="maxLoginAttempts">Tentatives de connexion max</label>
                                    <input type="number" id="maxLoginAttempts" name="maxLoginAttempts" value="{{ config.maxLoginAttempts|default('5') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="lockoutTime">Durée de verrouillage (minutes)</label>
                                    <input type="number" id="lockoutTime" name="lockoutTime" value="{{ config.lockoutTime|default('15') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="twoFactorAuth">Authentification à deux facteurs</label>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="twoFactorAuth" name="twoFactorAuth" {% if config.twoFactorAuth|default(false) %}checked{% endif %}>
                                        <label for="twoFactorAuth"></label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="forcePasswordChange">Forcer changement de mot de passe (jours)</label>
                                    <input type="number" id="forcePasswordChange" name="forcePasswordChange" value="{{ config.forcePasswordChange|default('90') }}">
                                    <small class="form-text">0 = désactivé</small>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="submit" class="btn-submit">Enregistrer</button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Onglet Sauvegarde -->
                        <div class="tab-content" id="backup-tab" role="tabpanel" aria-labelledby="tab-backup">
                            <form id="backupForm" class="config-form">
                                <div class="form-group">
                                    <label for="autoBackup">Sauvegarde automatique</label>
                                    <div class="toggle-switch">
                                        <input type="checkbox" id="autoBackup" name="autoBackup" {% if config.autoBackup|default(false) %}checked{% endif %}>
                                        <label for="autoBackup"></label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="backupFrequency">Fréquence de sauvegarde</label>
                                    <select id="backupFrequency" name="backupFrequency">
                                        <option value="daily" {% if config.backupFrequency|default('weekly') == 'daily' %}selected{% endif %}>Quotidienne</option>
                                        <option value="weekly" {% if config.backupFrequency|default('weekly') == 'weekly' %}selected{% endif %}>Hebdomadaire</option>
                                        <option value="monthly" {% if config.backupFrequency|default('weekly') == 'monthly' %}selected{% endif %}>Mensuelle</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="backupRetention">Conservation des sauvegardes (jours)</label>
                                    <input type="number" id="backupRetention" name="backupRetention" value="{{ config.backupRetention|default('30') }}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="backupStorage">Stockage des sauvegardes</label>
                                    <select id="backupStorage" name="backupStorage">
                                        <option value="local" {% if config.backupStorage|default('local') == 'local' %}selected{% endif %}>Local</option>
                                        <option value="s3" {% if config.backupStorage|default('local') == 's3' %}selected{% endif %}>Amazon S3</option>
                                        <option value="dropbox" {% if config.backupStorage|default('local') == 'dropbox' %}selected{% endif %}>Dropbox</option>
                                    </select>
                                </div>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn-secondary" id="create-manual-backup-btn">Créer une sauvegarde maintenant</button>
                                    <button type="submit" class="btn-submit">Enregistrer</button>
                                </div>
                            </form>
                            
                            <div class="backup-list">
                                <h3>Sauvegardes disponibles</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nom</th>
                                            <th>Date</th>
                                            <th>Taille</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if backups is defined and backups|length > 0 %}
                                            {% for backup in backups %}
                                                <tr>
                                                    <td>{{ backup.name }}</td>
                                                    <td>{{ backup.date|date('d/m/Y H:i') }}</td>
                                                    <td>{{ backup.size }}</td>
                                                    <td class="actions">
                                                        <button class="download-btn" data-backup-id="{{ backup.id }}">
                                                            <img src="{{ asset('build/images/settings/download.png') }}" alt="Télécharger">
                                                        </button>
                                                        <button class="restore-btn" data-backup-id="{{ backup.id }}" data-backup-name="{{ backup.name }}">
                                                            <img src="{{ asset('build/images/settings/restore.png') }}" alt="Restaurer">
                                                        </button>
                                                        <button class="delete-btn" data-backup-id="{{ backup.id }}" data-backup-name="{{ backup.name }}">
                                                            <img src="{{ asset('build/images/settings/delete.png') }}" alt="Supprimer">
                                                        </button>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center">Aucune sauvegarde disponible</td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

{# Modales #}
<div class="modal" id="restoreConfirmModal" tabindex="-1" role="dialog" aria-labelledby="restoreConfirmModalTitle" aria-modal="false" hidden>
    <div class="modal-content" role="document">
        <div class="modal-header">
            <h2 class="modal-title" id="restoreConfirmModalTitle">Confirmer la restauration</h2>
            <button type="button" class="close restore-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Êtes-vous sûr de vouloir restaurer la sauvegarde <span id="backupToRestoreName"></span> ?</p>
            <p class="warning">Attention : Cette action remplacera toutes les données actuelles par celles de la sauvegarde. Cette opération est irréversible.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel cancel-restore">Annuler</button>
            <button type="button" class="btn-danger confirm-restore">Restaurer</button>
        </div>
    </div>
</div>

<div class="modal" id="deleteBackupConfirmModal" tabindex="-1" role="dialog" aria-labelledby="deleteBackupConfirmModalTitle" aria-modal="false" hidden>
    <div class="modal-content" role="document">
        <div class="modal-header">
            <h2 class="modal-title" id="deleteBackupConfirmModalTitle">Confirmer la suppression</h2>
            <button type="button" class="close delete-backup-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Êtes-vous sûr de vouloir supprimer la sauvegarde <span id="backupToDeleteName"></span> ?</p>
            <p>Cette action est irréversible.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel cancel-delete-backup">Annuler</button>
            <button type="button" class="btn-danger confirm-delete-backup">Supprimer</button>
        </div>
    </div>
</div>

<div class="modal" id="testEmailModal" tabindex="-1" role="dialog" aria-labelledby="testEmailModalTitle" aria-modal="false" hidden>
    <div class="modal-content" role="document">
        <div class="modal-header">
            <h2 class="modal-title" id="testEmailModalTitle">Tester la configuration email</h2>
            <button type="button" class="close test-email-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="testEmailForm">
                <div class="form-group">
                    <label for="testEmailAddress">Adresse email de test</label>
                    <input type="email" id="testEmailAddress" name="testEmailAddress" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel cancel-test-email">Annuler</button>
            <button type="button" class="btn-submit confirm-test-email">Envoyer</button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('parameter/config') }}
{% endblock %} 